---
title: "Maine Coastal Current Indicators of Habitat and Ecosystem Change"
author: "Matt Dzaugis"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float:
        collapsed: FALSE
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(patchwork)
library(factoextra)
library(gmRi)
# Set theme  
theme_set(theme_bw())
```


```{r read_data}
# Indicators
allIndicators <- read_csv(here::here("Processed_Indicators/allIndicators.csv"))
allIndicators$Season <- factor(allIndicators$Season, levels= c("spring", "summer", "fall", "winter", "all"))
allIndicators$stat_area <- factor(allIndicators$stat_area, levels= c("511", "512", "513", "511-513"))
indicators <- unique(allIndicators$Indicator)

# Enter indicator, season, stat area of interest

indicator_sel <- "mcc"
season_sel <- "all"
stat_areas_sel <- "511-513"

# Enter the npsi (estimated number of breakpoints) - might need to run the code first and assess the breakpoint stats
Npsi <- 1 # estimated number of breakpoints
# enter a list of models for the mean breakpoint - a model of 1~1 indicates intercept, adding additional models incudes additional bp
model_list <- list(Value~1, 1~1, 1~1)
```


```{r functions}
plot_fun <- function(x, indicator){
  x %>% 
    filter(Indicator == indicator) %>% 
    ggplot() + 
    geom_line(aes(Year, Value, col = stat_area)) +
    theme_bw() +
    facet_wrap(~Season)
}

sumLms_fun <- function(indicator, season, stat_areas){
  df <- allIndicators %>% 
    filter(Indicator == indicator,
           Season == season,
           stat_area == stat_areas)
  
  lm1 <- lm(Value ~ Year, data = df)
  return(lm1)
}


acf_plot <- function(indicator, season, stat_areas){
    df <- allIndicators %>% 
    filter(Indicator == indicator,
           Season == season,
           stat_area == stat_areas) %>% 
      select(Year, Value)
  acf(df)
}

pscore_fun <- function(indicator, season, stat_areas){
  df <- allIndicators %>% 
    filter(Indicator == indicator,
           Season == season,
           stat_area == stat_areas)
  
  lm1 <- lm(Value ~ Year, data = df)
  pscore <- segmented::pscore.test(lm1)
  return(pscore)
}

davies_fun <- function(indicator, season, stat_areas){
  df <- allIndicators %>% 
    filter(Indicator == indicator,
           Season == season,
           stat_area == stat_areas)
  
  lm1 <- lm(Value ~ Year, data = df)
  davies <- segmented::davies.test(lm1)
  return(davies)
}

slope_bp_fun <- function(indicator, season, stat_areas, Npsi){
    df <- allIndicators %>% 
    filter(Indicator == indicator,
           Season == season,
           stat_area == stat_areas)
  
  lm1 <- lm(Value ~ Year, data = df)
  
  segmented::segmented(lm1, seg.Z = ~Year, npsi = Npsi)
}

mean_bp_fun <- function(indicator, season, stat_areas, models){
    df <- allIndicators %>% 
    filter(Indicator == indicator,
           Season == season,
           stat_area == stat_areas)
  
  lm1 <- lm(Value ~ Year, data = df)
  temp_mcp1 <- mcp::mcp(models, data = df, par_x = "Year")
  return(temp_mcp1)
}

```


`r use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")`

## Developing Indicators of Habitat and Ecosystem Change in the Gulf of Maine

This report includes the initial analysis of the ecosystem and habitat indicators. Linear regression was used to assess trends over the length of the time series. A trend breakpoint analysis and a mean breakpoint analysis were run on the indicators. A breakpoint found in the slope of the line indicates a change in the trend of the data. A breakpoint in the mean of the date may indicate a regime shift or change of the overall state of the system. These analyses were run seasonally within statistical areas, when available, and as yearly averages across the entire study domain. 

## Indicators

The following indicators are used in this report

* Surface salinity anomalies (FVCOM NECOFS)

### Surface Salinity {.tabset}

#### Time series plots

```{r plots}
plot_fun(allIndicators, indicator_sel)
```

#### Linear models

```{r lms}
lms <- sumLms_fun(indicator_sel, season_sel, stat_areas_sel)
plot(lms)
summary(lms)
acf_plot(indicator_sel, season_sel, stat_areas_sel)
```

#### Slope breakpoint tests

The pscore test and davies tests indicate whether a breakpoint in the slope exists. The davies test is more sensitive to data that follow a more sinusoidal curve but less sensitive to linear changes. A significant p-value indicates there is a breakpoint in the data. A non-significant p-value indicates a breakpoint is not present.

```{r breakpoint_tests}
pscore_fun(indicator_sel, season_sel, stat_areas_sel)
davies_fun(indicator_sel, season_sel, stat_areas_sel)
```

#### Slope breakpoint

```{r slope_segments}
bp <- slope_bp_fun(indicator_sel, season_sel, stat_areas_sel, Npsi)
summary(bp)
plot(bp)
df <- allIndicators %>% 
  filter(Indicator == indicator_sel,
         Season == season_sel,
         stat_area == stat_areas_sel)
points(x = df$Year, y = df$Value)
```


#### Mean breakpoint

```{r mean_bp}
mean_cp <- mean_bp_fun(indicator_sel, season_sel, stat_areas_sel, model_list)
summary(mean_cp)
plot(mean_cp)

```


